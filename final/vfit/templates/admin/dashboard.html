{% extends "base.html" %}
{% load humanize %}
{% block content %}
<div class="text-gray-100 font-poppins min-h-screen pt-20">
    <div class="flex">
        {% include 'admin/nav.html' %}
        <!-- Main Content -->
        <div class="text-black w-3/4 p-4 ml-80 mb-6 mt-8">
            <form method="GET" action="{% url 'dashboard' %}">
                <div class="flex justify-between mb-4">
                    <label for="incomeTimeRange" class="text-lg text-white">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤:</label>
                    <select id="incomeTimeRange" name="range" class="border rounded px-2 py-1 text-black" onchange="this.form.submit()">
                        <option value="daily" {% if range_type == "daily" %}selected{% endif %}>‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
                        <option value="weekly" {% if range_type == "weekly" %}selected{% endif %}>‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
                        <option value="monthly" {% if range_type == "monthly" %}selected{% endif %}>12‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                    </select>
                </div>
                {% if range_type == "daily" %}
                <div class="flex justify-between mb-4">
                    <label for="datePicker" class="text-lg text-white">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                    <input type="date" id="datePicker" name="date" value="{{ selected_date }}" class="border rounded px-2 py-1 text-gray-700" onchange="this.form.submit()">
                </div>
                {% endif %}
            </form>
            
            <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
            <div class="grid grid-cols-3 gap-4 mb-8">
                <div class="bg-white p-4 rounded-lg shadow-md text-center">
                    <p class="text-gray-700">
                        {% if range_type == "daily" %}
                            ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°:
                        {% elif range_type == "weekly" %}
                            ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ:
                        {% else %}
                            ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ:
                        {% endif %}
                    </p>
                    <p class="text-2xl text-black">{{ total_income|default:0|intcomma }} ‡∏ø</p>
                </div>
                <div class="bg-blue-500 p-4 rounded-lg shadow-md text-center">
                    <p class="text-white">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</p>
                    <p class="text-2xl text-white">{{ buy_income|default:0|intcomma }} ‡∏ø</p>
                </div>
                <div class="bg-green-500 p-4 rounded-lg shadow-md text-center">
                    <p class="text-white">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤</p>
                    <p class="text-2xl text-white">{{ rental_income|default:0|intcomma }} ‡∏ø</p>
                </div>
            </div>
            
            <div class="grid grid-cols-3 gap-4 mb-8">
                <div class="bg-white p-4 rounded-lg shadow-md text-center">
                    <p class="text-lg text-gray-700">
                        {% if range_type == "daily" %}
                            ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤‡∏¢‡∏∑‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                        {% elif range_type == "weekly" %}
                            ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤‡∏¢‡∏∑‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ
                        {% else %}
                            ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤‡∏¢‡∏∑‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏õ‡∏µ‡∏ô‡∏µ‡πâ
                        {% endif %}
                    </p>
                    <p class="text-3xl text-blue-500">{{ rental_orders }}</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md text-center">
                    <p class="text-lg text-gray-700">
                        {% if range_type == "daily" %}
                            ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                        {% elif range_type == "weekly" %}
                            ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ
                        {% else %}
                            ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏õ‡∏µ‡∏ô‡∏µ‡πâ
                        {% endif %}
                    </p>
                    <p class="text-3xl text-green-500">{{ buy_orders }}</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md text-center">
                    <p class="text-lg text-gray-700">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                    <p class="text-3xl text-red-500">{{ total_reports }}</p>
                </div>
            </div>

            <!-- ‡∏Å‡∏£‡∏≤‡∏ü -->
            <div class="grid grid-cols-2 gap-8">
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <div class="flex justify-between mb-4">
                        <p class="text-lg text-gray-700">‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</p>
                    </div>
                    <canvas id="incomeChart" class="w-full h-64"></canvas>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-md">
                    <div class="flex justify-between mb-4">
                        <p class="text-lg text-gray-700">‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤-‡∏ã‡∏∑‡πâ‡∏≠</p>
                    </div>
                    <canvas id="orderChart" class="w-full h-64"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const ctx1 = document.getElementById('incomeChart').getContext('2d');
        const ctx2 = document.getElementById('orderChart').getContext('2d');

        let chartLabels = [];
        let rentalIncomeData = [];
        let buyIncomeData = [];
        let rentalOrdersData = [];
        let buyOrdersData = [];

        try {
            {% if range_type == "daily" %}
                const dailyData = JSON.parse('{{ daily_data|safe }}');
                console.log("Debug: Daily Data", dailyData); // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

                chartLabels = [dailyData.label];
                rentalIncomeData = [dailyData.rental_income];
                buyIncomeData = [dailyData.buy_income];
                rentalOrdersData = [dailyData.rental_orders || 0]; // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 0
                buyOrdersData = [dailyData.buy_orders || 0]; // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 0

            {% elif range_type == "weekly" %}
                const weeklyData = JSON.parse('{{ weekly_data|safe }}' || "[]");
                if (!weeklyData.length) throw new Error("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå");

                console.log("Debug: Weekly Data", weeklyData);
                weeklyData.forEach(item => {
                    chartLabels.push(item.label);
                    rentalIncomeData.push(item.rental_income);
                    buyIncomeData.push(item.buy_income);
                    rentalOrdersData.push(item.rental_orders);
                    buyOrdersData.push(item.buy_orders);
                });

            {% elif range_type == "monthly" %}
                const monthlyData = JSON.parse('{{ monthly_data|safe }}' || "[]");
                if (!monthlyData.length) throw new Error("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô");

                console.log("Debug: Monthly Data", monthlyData);
                monthlyData.forEach(item => {
                    chartLabels.push(item.label);
                    rentalIncomeData.push(item.rental_income);
                    buyIncomeData.push(item.buy_income);
                    rentalOrdersData.push(item.rental_orders);
                    buyOrdersData.push(item.buy_orders);
                });
            {% endif %}
        } catch (error) {
            console.error("üö® Error Parsing JSON:", error);
        }

        // ‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ
        new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: chartLabels,
                datasets: [
                    { label: '‡∏ã‡∏∑‡πâ‡∏≠', data: buyIncomeData, backgroundColor: 'rgba(54, 162, 235, 0.6)' },
                    { label: '‡πÄ‡∏ä‡πà‡∏≤', data: rentalIncomeData, backgroundColor: 'rgba(255, 206, 86, 0.6)' }
                ],
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });

        // ‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤-‡∏ã‡∏∑‡πâ‡∏≠ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡πà‡∏≤)
        if (rentalOrdersData.length > 0 && buyOrdersData.length > 0) {
            new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [
                        { label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ä‡πà‡∏≤', data: rentalOrdersData, borderColor: 'rgba(255, 99, 132, 1)', fill: true },
                        { label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ã‡∏∑‡πâ‡∏≠', data: buyOrdersData, borderColor: 'rgba(54, 162, 235, 1)', fill: true }
                    ],
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        } else {
            console.warn("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤-‡∏ã‡∏∑‡πâ‡∏≠");
        }
    });
</script>

{% endblock %}
